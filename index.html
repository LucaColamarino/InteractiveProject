<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Metamorphosis - Evolve Beyond</title>
<!-- Fonts -->

<!-- Design System -->

<!-- HUD Styles -->

<!-- Main Menu Styles -->

<!-- Meta tags per PWA/Gaming -->
<meta content="#64c8ff" name="theme-color"/>
<meta content="Un'esperienza di evoluzione biologica immersiva in 3D" name="description"/>
<!-- Performance hints -->
<link as="style" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&amp;family=Exo+2:wght@300;400;600;700&amp;display=swap" rel="preload"/>

<link href="./src/ui/design-system.css" rel="stylesheet"/><link href="./hud.css" rel="stylesheet"/><link href="./src/ui/mainMenu.css" rel="stylesheet"/></head>
<body>
<!-- Loading Screen -->
<div id="loading-screen">
<div class="loading-logo">METAMORPHOSIS</div>
<div class="loading-bar">
<div class="loading-progress" id="loading-progress"></div>
</div>
<p class="loading-message" id="loading-message">
            Inizializzazione della simulazione biologica...
        </p>
</div>
<!-- Canvas 3D -->
<canvas id="three-canvas"></canvas>
<!-- HUD Overlay -->
<div id="hud-overlay">
<!-- TOP CENTER - INTERACTION PROMPTS -->
<div class="interaction-wrap">
<div class="interaction-prompt" hidden="" id="interaction-prompts">
<span aria-label="Tasto di interazione" id="interaction-key">E</span>
<span id="interaction-text">Interagisci</span>
</div>
</div>
<!-- TOP RIGHT - MINIMAP & INFO -->
<div class="minimap-wrap">
<div class="hud-minimap minimap-viewport" role="img">
<div class="minimap-grid">
<div aria-hidden="true" class="minimap-heading"></div>
</div>
</div>
<!-- Pills informative -->
<div class="minimap-hud">
<div aria-label="Nemici nelle vicinanze" class="pill" id="mm-enemies">🎯 0</div>
<!-- Tempo di gioco, Coordinate, Livello 
                <div class="pill" id="mm-time" aria-label="Tempo di gioco">⏰ --:--</div>
                <div class="pill" id="mm-coords" aria-label="Coordinate giocatore">📍 0,0,0</div> 
                
                -->
<div aria-label="Livello del giocatore" class="pill" id="mm-level">🧬 LVL 1</div>
</div>
</div>
<!-- BOTTOM CENTER - VITALS -->
<div aria-label="Statistiche vitali" class="hud-vitals" role="region">
<!-- Health -->
<div>
<div class="hud-label">❤️ Salute</div>
<div aria-label="Salute" aria-valuemax="100" aria-valuemin="0" aria-valuenow="85" class="progress-container" role="progressbar">
<div class="progress-bar health-bar" id="health-bar" style="width: 85%;">
<div class="progress-text" id="health-text">850 / 1000</div>
</div>
</div>
</div>
<!-- Mana -->
<div>
<div class="hud-label">💙 Mana</div>
<div aria-label="Mana" aria-valuemax="100" aria-valuemin="0" aria-valuenow="60" class="progress-container" role="progressbar">
<div class="progress-bar mana-bar" id="mana-bar" style="width: 60%;">
<div class="progress-text" id="mana-text">300 / 500</div>
</div>
</div>
</div>
<!-- Stamina -->
<div>
<div class="hud-label">⚡ Stamina</div>
<div aria-label="Stamina" aria-valuemax="100" aria-valuemin="0" aria-valuenow="40" class="progress-container" role="progressbar">
<div class="progress-bar stamina-bar" id="stamina-bar" style="width: 40%;">
<div class="progress-text" id="stamina-text">40 / 100</div>
</div>
</div>
</div>
<!-- Experience -->
<div>
<div class="hud-label">🧬 Esperienza</div>
<div aria-label="Esperienza" aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" class="progress-container" role="progressbar">
<div class="progress-bar xp-bar" id="xp-bar" style="width: 0%;">
<div class="progress-text" id="xp-text">0 / 100</div>
</div>
</div>
</div>
</div>
<!-- NOTIFICATIONS -->
<div aria-label="Notifiche di gioco" aria-live="polite" class="notification-area" id="notifications" role="log">
<!-- Le notifiche vengono aggiunte dinamicamente -->
</div>
</div>
<!-- Scripts -->
<script>
        // SISTEMA DI LOADING CORRETTO - Versione Fissa
        console.log('[Loading] Inizializzazione sistema di caricamento...');
        
        let loadingProgress = 0;
        let isGameStarted = false;
        
        // Elementi DOM
        const loadingScreen = document.getElementById('loading-screen');
        const progressBar = document.getElementById('loading-progress');
        const loadingMessage = document.getElementById('loading-message');
        
        // FUNZIONE PRINCIPALE PER AGGIORNARE IL PROGRESSO
        function updateLoadingProgress(percent, message = '') {
            if (isGameStarted) return; // Impedisce aggiornamenti dopo che il gioco è iniziato
            
            loadingProgress = Math.min(100, Math.max(0, percent));
            
            console.log(`[Loading] Progress: ${loadingProgress}% - ${message}`);
            
            // Aggiorna barra visualmente
            if (progressBar) {
                progressBar.style.width = loadingProgress + '%';
            }
            
            // Aggiorna messaggio
            if (loadingMessage && message) {
                loadingMessage.textContent = message;
            }
            
            // Auto-nascondi quando raggiungiamo il 100%
            if (loadingProgress >= 100) {
                setTimeout(() => {
                    hideLoadingScreen();
                }, 800);
            }
        }
        
        // FUNZIONE PER NASCONDERE IL LOADING SCREEN
        function hideLoadingScreen() {
            if (!loadingScreen || isGameStarted) return;
            
            console.log('[Loading] Nascondendo schermata di caricamento...');
            isGameStarted = true;
            
            loadingScreen.classList.add('hidden');
            setTimeout(() => {
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                console.log('[Loading] Schermata nascosta completamente');
            }, 500);
        }
        
        // SIMULAZIONE CARICAMENTO (Per test - rimuovi in produzione)
        function simulateLoading() {
            console.log('[Loading] Avvio simulazione caricamento per test...');
            
            const steps = [
                { percent: 5, message: 'Configurazione impostazioni...', delay: 300 },
                { percent: 15, message: 'Caricamento asset e risorse...', delay: 600 },
                { percent: 25, message: 'Configurazione controlli...', delay: 400 },
                { percent: 45, message: 'Generazione terreno...', delay: 800 },
                { percent: 55, message: 'Creazione cielo e acqua...', delay: 500 },
                { percent: 70, message: 'Popolamento vegetazione...', delay: 700 },
                { percent: 80, message: 'Spawn nemici...', delay: 400 },
                { percent: 90, message: 'Posizionamento oggetti...', delay: 600 },
                { percent: 95, message: 'Inizializzazione giocatore...', delay: 500 },
                { percent: 100, message: 'Finalizzazione...', delay: 400 }
            ];
            
            let currentStep = 0;
            
            function runNextStep() {
                if (currentStep >= steps.length || isGameStarted) return;
                
                const step = steps[currentStep];
                updateLoadingProgress(step.percent, step.message);
                
                currentStep++;
                setTimeout(runNextStep, step.delay);
            }
            
            // Inizia la simulazione
            setTimeout(runNextStep, 500);
        }
        
        // Esporta API globale per il gioco
            window.gameUI = {
            updateLoadingProgress,
            hideLoadingScreen,    // hard hide: segna isGameStarted=true
            showLoadingScreen,    // riapre il loader per mostrare la barra
            suspendLoadingScreen, // soft hide: solo per mostrare il menu
            isLoadingComplete: () => isGameStarted
            };

        
        // Event handlers per errori
        window.addEventListener('error', (e) => {
            console.error('[Loading] Errore globale:', e.error);
            if (!isGameStarted) {
                updateLoadingProgress(0, 'Errore di caricamento - Riprova...');
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('[Loading] Promise rejection:', e.reason);
            if (!isGameStarted) {
                updateLoadingProgress(0, 'Errore di inizializzazione...');
            }
        });

            function showLoadingScreen() {
            // ri-mostro il loader e consento gli aggiornamenti
            isGameStarted = false;
            if (!loadingScreen) return;
            loadingScreen.style.display = 'flex';
            // rimuovo la classe hidden al frame successivo per fare il fade-in
            requestAnimationFrame(() => loadingScreen.classList.remove('hidden'));
            }

            function suspendLoadingScreen() {
            // nasconde il loader senza segnare il gioco come "iniziato"
            if (!loadingScreen) return;
            loadingScreen.classList.add('hidden');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
            }

    </script>
<script src="./src/main.js" type="module"></script>
</body>
</html>